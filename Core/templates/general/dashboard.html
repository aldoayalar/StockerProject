{% extends "general/base.html" %}
{% load static %}

{% block title %}Dashboard - Stocker - Sistema de gestión de inventario inteligente{% endblock %}

{% block extra_css %}
<style>
    .kpi-card {
        border-radius: 10px;
        padding: 20px;
        color: white;
        transition: transform 0.3s;
        border: none;
    }
    
    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    
    .kpi-card.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .kpi-card.success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .kpi-card.warning {
        background: linear-gradient(135deg, #ffc107 0%, #ff6b6b 100%);
    }
    
    .kpi-card.danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    
    .kpi-card.info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    }
    
    .kpi-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .kpi-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    
    .activity-item {
        padding: 12px;
        border-left: 3px solid #dee2e6;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        transition: all 0.2s;
    }
    
    .activity-item:hover {
        background: #e9ecef;
        border-left-color: #667eea;
    }
    
    .activity-item.entrada {
        border-left-color: #28a745;
    }
    
    .activity-item.salida {
        border-left-color: #dc3545;
    }
    
    .activity-item.ajuste {
        border-left-color: #ffc107;
    }
    
    .rol-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .rol-badge.tecnico {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
    }
    
    .rol-badge.bodega {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .rol-badge.gerencia {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
</style>
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="fas fa-chart-line"></i> Dashboard
                <span class="rol-badge {{ usuario.rol|lower }}">{{ usuario.get_rol_display }}</span>
            </h2>
            <p class="text-muted mb-0">Bienvenido, <strong>{{ usuario.get_full_name|default:usuario.username }}</strong></p>
        </div>
    </div>

    <!-- KPIs ADAPTADOS POR ROL -->
    <div class="row mb-4">
        {% if rol == 'TECNICO' %}
            <!-- KPIs para Técnico: enfocados en sus solicitudes personales -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card primary">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <div class="kpi-value">{{ mis_solicitudes_count }}</div>
                    <div class="kpi-label">Mis Solicitudes</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card warning">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <div class="kpi-value">{{ mis_pendientes }}</div>
                    <div class="kpi-label">En Espera</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card success">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <div class="kpi-value">{{ mis_aprobadas }}</div>
                    <div class="kpi-label">Aprobadas</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card info">
                    <i class="fas fa-boxes fa-2x mb-2"></i>
                    <div class="kpi-value">{{ total_materiales }}</div>
                    <div class="kpi-label">Materiales Disponibles</div>
                </div>
            </div>
            
        {% elif rol == 'BODEGA' %}
            <!-- KPIs para Bodega: enfocados en inventario y solicitudes pendientes -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card warning">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <div class="kpi-value">{{ solicitudes_pendientes }}</div>
                    <div class="kpi-label">Solicitudes Pendientes</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <div class="kpi-value">{{ materiales_criticos }}</div>
                    <div class="kpi-label">Stock Crítico</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card info">
                    <i class="fas fa-cubes fa-2x mb-2"></i>
                    <div class="kpi-value">{{ stock_total }}</div>
                    <div class="kpi-label">Stock Total</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card primary">
                    <i class="fas fa-boxes fa-2x mb-2"></i>
                    <div class="kpi-value">{{ total_materiales }}</div>
                    <div class="kpi-label">Total Materiales</div>
                </div>
            </div>
            
        {% elif rol == 'GERENCIA' %}
            <!-- KPIs para Gerencia: vista completa del sistema -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card primary">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <div class="kpi-value">{{ total_usuarios }}</div>
                    <div class="kpi-label">Total Usuarios</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card success">
                    <i class="fas fa-boxes fa-2x mb-2"></i>
                    <div class="kpi-value">{{ total_materiales }}</div>
                    <div class="kpi-label">Total Materiales</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card warning">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <div class="kpi-value">{{ solicitudes_pendientes }}</div>
                    <div class="kpi-label">Solicitudes Pendientes</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card kpi-card danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <div class="kpi-value">{{ materiales_criticos }}</div>
                    <div class="kpi-label">Materiales Críticos</div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Gráficos (SOLO BODEGA Y GERENCIA) -->
    {% if rol == 'BODEGA' or rol == 'GERENCIA' %}
    <div class="row mb-4">
        <!-- Gráfico: Materiales por Categoría -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Materiales por Categoría</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartCategorias"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gráfico: Solicitudes por Estado -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Solicitudes del Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartSolicitudes"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Gráfico de Solicitudes para TÉCNICO -->
    {% if rol == 'TECNICO' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Mis Solicitudes por Estado</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartSolicitudes"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Gráfico: Movimientos Últimos 7 Días (solo para Bodega y Gerencia) -->
    {% if rol == 'BODEGA' or rol == 'GERENCIA' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Movimientos - Últimos 7 Días</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="chartMovimientos"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Top 5 Materiales Más Solicitados (SOLO BODEGA Y GERENCIA) -->
        {% if rol == 'BODEGA' or rol == 'GERENCIA' %}
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="fas fa-star"></i> Top 5 Materiales Más Solicitados</h5>
                </div>
                <div class="card-body">
                    {% if top_materiales %}
                    <div class="list-group list-group-flush">
                        {% for item in top_materiales %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ item.material__descripcion }}</strong>
                                <br>
                                <small class="text-muted">{{ item.material__codigo }}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">
                                {{ item.total_solicitado }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No hay datos de solicitudes</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Materiales en Stock Crítico (SOLO BODEGA Y GERENCIA) -->
        {% if rol == 'BODEGA' or rol == 'GERENCIA' %}
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-circle"></i> Materiales en Stock Crítico</h5>
                </div>
                <div class="card-body">
                    {% if materiales_criticos_lista %}
                    <div class="list-group list-group-flush">
                        {% for inv in materiales_criticos_lista %}
                        <a href="{% url 'detalle_material' inv.material.id %}" 
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ inv.material.descripcion }}</strong>
                                <br>
                                <small class="text-muted">{{ inv.material.codigo }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-danger">{{ inv.stock_actual }}</span>
                                <small class="text-muted d-block">de {{ inv.stock_seguridad }}</small>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <br>No hay materiales en stock crítico
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Mis Materiales Más Solicitados (SOLO TÉCNICO) -->
        {% if rol == 'TECNICO' %}
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="fas fa-star"></i> Mis Materiales Más Solicitados</h5>
                </div>
                <div class="card-body">
                    {% if top_materiales %}
                    <div class="list-group list-group-flush">
                        {% for item in top_materiales %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ item.material__descripcion }}</strong>
                                <br>
                                <small class="text-muted">{{ item.material__codigo }}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">
                                {{ item.total_solicitado }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No has solicitado materiales aún</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Actividad Reciente y Solicitudes Recientes -->
    <div class="row">
        <!-- Solicitudes Recientes -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history"></i> 
                        {% if rol == 'TECNICO' %}
                            Mis Solicitudes Recientes
                        {% else %}
                            Solicitudes Recientes
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if solicitudes_recientes %}
                    {% for solicitud in solicitudes_recientes %}
                    <div class="activity-item">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>#{{ solicitud.id }}</strong>
                                {% if rol != 'TECNICO' %}
                                    - {{ solicitud.solicitante.username }}
                                {% endif %}
                                <br>
                                <small class="text-muted">
                                    {{ solicitud.total_items }} material(es) - {{ solicitud.fecha_solicitud|date:"d/m/Y H:i" }}
                                </small>
                            </div>
                            <span class="badge 
                                {% if solicitud.estado == 'pendiente' %}bg-warning
                                {% elif solicitud.estado == 'aprobada' %}bg-success
                                {% elif solicitud.estado == 'rechazada' %}bg-danger
                                {% else %}bg-info{% endif %}">
                                {{ solicitud.get_estado_display }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted text-center py-3">No hay solicitudes recientes</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Actividad Reciente (Movimientos) - Solo para Bodega y Gerencia -->
        {% if rol == 'BODEGA' or rol == 'GERENCIA' %}
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-stream"></i> Actividad Reciente</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if actividad_reciente %}
                    {% for mov in actividad_reciente %}
                    <div class="activity-item {{ mov.tipo }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <span class="badge 
                                    {% if mov.tipo == 'entrada' %}bg-success
                                    {% elif mov.tipo == 'salida' %}bg-danger
                                    {% else %}bg-warning{% endif %} me-2">
                                    {{ mov.tipo|upper }}
                                </span>
                                <strong>{{ mov.material.descripcion }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ mov.usuario.nombre }} {{ mov.usuario.apellido }} - 
                                    {{ mov.fecha|date:"d/m H:i" }}
                                </small>
                            </div>
                            <strong class="text-end">
                                {% if mov.tipo == 'entrada' %}+{% elif mov.tipo == 'salida' %}-{% endif %}{{ mov.cantidad }}
                            </strong>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted text-center py-3">No hay actividad reciente</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <!-- Para técnicos: mostrar consejos o información útil -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Información Útil</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-2">
                        <i class="fas fa-lightbulb"></i> 
                        <strong>Tip:</strong> Puedes crear solicitudes de materiales desde el menú lateral.
                    </div>
                    <div class="alert alert-warning mb-2">
                        <i class="fas fa-clock"></i> 
                        Las solicitudes pendientes serán revisadas por el personal de bodega.
                    </div>
                    <div class="alert alert-success mb-0">
                        <i class="fas fa-check"></i> 
                        Puedes ver el historial completo de tus solicitudes en el menú Solicitudes.
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Colores personalizados
const colors = {
    primary: '#667eea',
    success: '#28a745',
    warning: '#ffc107',
    danger: '#dc3545',
    info: '#17a2b8',
};

{% if rol == 'BODEGA' or rol == 'GERENCIA' %}
// ==================== GRÁFICO 1: MATERIALES POR CATEGORÍA ====================
const ctxCategorias = document.getElementById('chartCategorias');
if (ctxCategorias) {
    new Chart(ctxCategorias.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: JSON.parse('{{ categorias_labels|escapejs }}'),
            datasets: [{
                data: JSON.parse('{{ categorias_data|escapejs }}'),
                backgroundColor: [
                    colors.primary,
                    colors.success,
                    colors.warning,
                    colors.danger,
                    colors.info,
                    '#a29bfe',
                    '#fd79a8',
                    '#fdcb6e',
                    '#6c5ce7',
                    '#fab1a0'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}
{% endif %}

// ==================== GRÁFICO 2: SOLICITUDES POR ESTADO ====================
const ctxSolicitudes = document.getElementById('chartSolicitudes');
if (ctxSolicitudes) {
    new Chart(ctxSolicitudes.getContext('2d'), {
        type: 'bar',
        data: {
            labels: JSON.parse('{{ solicitudes_labels|escapejs }}'),
            datasets: [{
                label: 'Cantidad',
                data: JSON.parse('{{ solicitudes_data|escapejs }}'),
                backgroundColor: [
                    colors.warning,
                    colors.success,
                    colors.danger,
                    colors.info
                ],
                borderWidth: 0,
                borderRadius: 8,
                barThickness: 40
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : '';
                        }
                    }
                }
            }
        }
    });
}

// ==================== GRÁFICO 3: MOVIMIENTOS ÚLTIMOS 7 DÍAS ====================
{% if rol == 'BODEGA' or rol == 'GERENCIA' %}
const ctxMovimientos = document.getElementById('chartMovimientos');
if (ctxMovimientos) {
    new Chart(ctxMovimientos.getContext('2d'), {
        type: 'line',
        data: {
            labels: JSON.parse('{{ movimientos_fechas|escapejs }}'),
            datasets: [
                {
                    label: 'Entradas',
                    data: JSON.parse('{{ movimientos_entradas|escapejs }}'),
                    borderColor: colors.success,
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: colors.success,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                },
                {
                    label: 'Salidas',
                    data: JSON.parse('{{ movimientos_salidas|escapejs }}'),
                    borderColor: colors.danger,
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: colors.danger,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : '';
                        }
                    }
                }
            }
        }
    });
}
{% endif %}
</script>
{% endblock %}
