{% extends 'general/base.html' %}
{% block title %}<h2><i class="fas fa-tasks"></i> Gestionar Solicitudes</h2>{% endblock %}
{% block contenido %}

{% if user.rol != 'BODEGA' %}
<div class="container-fluid" style="min-height: 80vh; display: flex; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8">
        <div class="card border-0 shadow-lg rounded-4">
          <div class="card-body p-5">
            <!-- Icono y título -->
            <div class="text-center mb-4">
              <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" 
                   style="width: 100px; height: 100px;">
                <i class="fas fa-ban fa-3x text-danger"></i>
              </div>
              <h2 class="mt-4 fw-bold text-dark">Acceso No Autorizado</h2>
            </div>
            
            <!-- Mensaje principal -->
            <div class="alert alert-danger border-0 shadow-sm" role="alert">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-circle fa-2x me-3"></i>
                <div>
                  <h5 class="alert-heading mb-1">Permisos Insuficientes</h5>
                  <p class="mb-0">No tienes autorización para gestionar solicitudes.</p>
                </div>
              </div>
            </div>
            
            <!-- Detalles -->
            <div class="row g-3 mb-4">
              <div class="col-6">
                <div class="p-3 bg-light rounded text-center">
                  <small class="text-muted d-block mb-1">Tu Rol</small>
                  <span class="badge bg-secondary fs-6">{{ user.get_rol_display }}</span>
                </div>
              </div>
              <div class="col-6">
                <div class="p-3 bg-light rounded text-center">
                  <small class="text-muted d-block mb-1">Rol Requerido</small>
                  <span class="badge bg-success fs-6">Bodega</span>
                </div>
              </div>
            </div>
            
            <!-- Mensaje informativo -->
            <div class="bg-info bg-opacity-10 border-start border-info border-4 p-3 mb-4">
              <p class="mb-0">
                <i class="fas fa-lightbulb text-info me-2"></i>
                <strong>Nota:</strong> Si necesitas acceso, contacta al administrador del sistema.
              </p>
            </div>
            
            <!-- Botones de acción -->
            <div class="d-flex gap-2">
              <a href="{% url 'dashboard' %}" class="btn btn-primary flex-fill">
                <i class="fas fa-home"></i> Ir al Dashboard
              </a>
              <a href="javascript:history.back()" class="btn btn-outline-secondary flex-fill">
                <i class="fas fa-arrow-left"></i> Volver
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}


<div class="container mt-4">
  <div class="card shadow">
    <div class="card-header bg-warning text-dark">
      <h4><i class="fas fa-file-alt"></i> Listado de Solicitudes </h4>
    </div>
    <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Solicitante</th>
            <th>Material</th>
            <th>Cantidad</th>
            <th>Motivo</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for solicitud in todas_solicitudes %}
            <tr>
              <td>{{ solicitud.id }}</td>
              <td>{{ solicitud.solicitante.username }}</td>
              <td>
                {% for detalle in solicitud.detalles.all %}
                  {{ detalle.material.descripcion }}<br>
                {% endfor %}
              </td>
              <td>
                {% for detalle in solicitud.detalles.all %}
                  {{ detalle.cantidad }}<br>
                {% endfor %}
              </td>
              <td>{{ solicitud.motivo|truncatewords:5 }}</td>
              
              <td>
                {% if solicitud.estado == 'pendiente' %}
                  <span class="badge bg-warning text-dark">Pendiente</span>
                {% elif solicitud.estado == 'aprobada' %}
                  <span class="badge bg-info">Aprobada</span>
                {% elif solicitud.estado == 'despachada' %}
                  <span class="badge bg-success">Despachada</span>
                {% elif solicitud.estado == 'rechazada' %}
                  <span class="badge bg-danger">Rechazada</span>
                {% endif %}
              </td>
              
              <td>{{ solicitud.fecha_solicitud|date:"d/m/Y" }}</td>
              <td>
                {% if solicitud.estado == 'pendiente' %}
                  <!-- Formulario para aprobar -->
                  <form method="POST" action="{% url 'aprobar_solicitud' solicitud.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-sm" 
                            onclick="return confirm('¿Aprobar esta solicitud?')">
                      <i class="fas fa-check"></i> Aprobar
                    </button>
                  </form>
                  
                  <!-- Formulario para rechazar -->
                  <form method="POST" action="{% url 'rechazar_solicitud' solicitud.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm" 
                            onclick="return confirm('¿Rechazar esta solicitud?')">
                      <i class="fas fa-times"></i> Rechazar
                    </button>
                  </form>
                  
                {% elif solicitud.estado == 'aprobada' %}
                  <!-- Formulario para despachar -->
                  <form method="POST" action="{% url 'despachar_solicitud' solicitud.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary btn-sm" 
                            onclick="return confirm('¿Despachar esta solicitud? Se descontará el stock.')">
                      <i class="fas fa-truck"></i> Despachar
                    </button>
                  </form>
                  
                {% else %}
                  <span class="text-muted small">
                    {% if solicitud.estado == 'despachada' %}
                      <i class="fas fa-check-circle text-success"></i> Despachada
                    {% elif solicitud.estado == 'rechazada' %}
                      <i class="fas fa-times-circle text-danger"></i> Rechazada
                    {% endif %}
                  </span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted">No hay solicitudes registradas</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    </div>
  </div>
</div>

{% endif %}
{% endblock %}
