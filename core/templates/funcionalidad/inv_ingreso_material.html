{% extends 'general/base.html' %}
{% load static %}

{% block title %}Nuevo Material{% endblock %}

{% block extra_css %}
<style>
    .form-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 30px;
        border-radius: 10px 10px 0 0;
        margin: -1rem -1rem 0 -1rem;
    }
    
    .form-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #28a745;
    }
    
    .form-section h5 {
        color: #28a745;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .input-group-text {
        background-color: #28a745;
        color: white;
        border-color: #28a745;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .info-box {
        background: #e7f3ff;
        border-left: 4px solid #0dcaf0;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    .btn-action {
        padding: 12px 30px;
        font-size: 1rem;
        border-radius: 8px;
        transition: all 0.3s;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <div class="card shadow-lg border-0">
        <!-- Header -->
        <div class="form-header">
            <h2 class="mb-2">
                <i class="fas fa-plus-circle"></i> Ingreso de Nuevo Material
            </h2>
            <p class="mb-0 opacity-75">Completa la información del material a ingresar al inventario</p>
        </div>
        
        <div class="card-body p-4">
            <!-- Info Box -->
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <strong>Nota:</strong> Los campos marcados con <span class="text-danger">*</span> son obligatorios.
                El código se genera automáticamente pero puedes modificarlo si es necesario.
            </div>
            
            <form method="post" id="formMaterial">
                {% csrf_token %}
                
                <!-- Errores generales -->
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ form.non_field_errors }}
                </div>
                {% endif %}
                
                <!-- Sección: Identificación -->
                <div class="form-section">
                    <h5><i class="fas fa-id-card"></i> Identificación del Material</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_codigo" class="form-label required-field">Código</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                {{ form.codigo }}
                            </div>
                            {% if form.codigo.errors %}
                            <div class="text-danger small mt-1">
                                <i class="fas fa-exclamation-circle"></i> {{ form.codigo.errors.0 }}
                            </div>
                            {% endif %}
                            <div class="help-text">
                                <i class="fas fa-lightbulb"></i> Se genera automáticamente (Ej: MAT0001)
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="id_categoria" class="form-label required-field">Categoría</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-tags"></i></span>
                                {{ form.categoria }}
                            </div>
                            {% if form.categoria.errors %}
                            <div class="text-danger small mt-1">
                                <i class="fas fa-exclamation-circle"></i> {{ form.categoria.errors.0 }}
                            </div>
                            {% endif %}
                            <div class="help-text">
                                <i class="fas fa-lightbulb"></i> Tipo de material
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_descripcion" class="form-label required-field">Descripción</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                            {{ form.descripcion }}
                        </div>
                        {% if form.descripcion.errors %}
                        <div class="text-danger small mt-1">
                            <i class="fas fa-exclamation-circle"></i> {{ form.descripcion.errors.0 }}
                        </div>
                        {% endif %}
                        <div class="help-text">
                            <i class="fas fa-lightbulb"></i> Describe claramente el material
                        </div>
                    </div>
                </div>
                
                <!-- Sección: Medida y Ubicación -->
                <div class="form-section">
                    <h5><i class="fas fa-ruler-combined"></i> Medida y Ubicación</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_unidad_medida" class="form-label required-field">Unidad de Medida</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-ruler"></i></span>
                                {{ form.unidad_medida }}
                            </div>
                            {% if form.unidad_medida.errors %}
                            <div class="text-danger small mt-1">
                                <i class="fas fa-exclamation-circle"></i> {{ form.unidad_medida.errors.0 }}
                            </div>
                            {% endif %}
                            <div class="help-text">
                                <i class="fas fa-lightbulb"></i> Cómo se mide el material
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="id_ubicacion" class="form-label">Ubicación en Bodega</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                {{ form.ubicacion }}
                            </div>
                            {% if form.ubicacion.errors %}
                            <div class="text-danger small mt-1">
                                <i class="fas fa-exclamation-circle"></i> {{ form.ubicacion.errors.0 }}
                            </div>
                            {% endif %}
                            <div class="help-text">
                                <i class="fas fa-lightbulb"></i> Ej: Estante A, Nivel 2
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sección: Stock -->
                <div class="form-section">
                    <h5><i class="fas fa-cubes"></i> Control de Stock</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_stock_actual" class="form-label required-field">Stock Inicial</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-boxes"></i></span>
                                {{ form.stock_actual }}
                                <span class="input-group-text bg-light text-dark" id="unidad-stock-actual">unidades</span>
                            </div>
                            {% if form.stock_actual.errors %}
                            <div class="text-danger small mt-1">
                                <i class="fas fa-exclamation-circle"></i> {{ form.stock_actual.errors.0 }}
                            </div>
                            {% endif %}
                            <div class="help-text">
                                <i class="fas fa-lightbulb"></i> Cantidad con la que inicias
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="id_stock_seguridad" class="form-label required-field">Stock de Seguridad</label>
                            <div class="input-group">
                                <span class="input-group-text bg-warning text-dark"><i class="fas fa-exclamation-triangle"></i></span>
                                {{ form.stock_seguridad }}
                                <span class="input-group-text bg-light text-dark" id="unidad-stock-seguridad">alerta</span>
                            </div>
                            {% if form.stock_seguridad.errors %}
                            <div class="text-danger small mt-1">
                                <i class="fas fa-exclamation-circle"></i> {{ form.stock_seguridad.errors.0 }}
                            </div>
                            {% endif %}
                            <div class="help-text">
                                <i class="fas fa-lightbulb"></i> Nivel mínimo antes de alertar
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visualización del nivel de stock -->
                    <div class="alert alert-info mt-2">
                        <i class="fas fa-info-circle"></i>
                        <strong>Información:</strong> Recibirás una notificación cuando el stock llegue o esté por debajo del nivel de seguridad.
                    </div>
                </div>
                
                <!-- Botones -->
                <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                    <a href="{% url 'inventario' %}" class="btn btn-outline-secondary btn-action">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-success btn-action">
                        <i class="fas fa-check-circle"></i> Guardar Material
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Mapeo de unidades para mostrar en español
    const unidadesMap = {
        'unidad': 'unidades',
        'kg': 'kilogramos',
        'metro': 'metros',
        'litro': 'litros'
    };
    
    // Función para actualizar las etiquetas de unidad
    function actualizarUnidades() {
        const unidadSelect = document.getElementById('id_unidad_medida');
        const unidadStockActual = document.getElementById('unidad-stock-actual');
        const unidadStockSeguridad = document.getElementById('unidad-stock-seguridad');
        
        if (unidadSelect && unidadStockActual && unidadStockSeguridad) {
            const unidadSeleccionada = unidadSelect.value;
            const unidadTexto = unidadesMap[unidadSeleccionada] || unidadSeleccionada || 'unidades';
            
            unidadStockActual.textContent = unidadTexto;
            unidadStockSeguridad.textContent = unidadTexto;
        }
    }
    
    // Ejecutar al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        actualizarUnidades();
        
        // Escuchar cambios en la unidad de medida
        const unidadSelect = document.getElementById('id_unidad_medida');
        if (unidadSelect) {
            unidadSelect.addEventListener('change', actualizarUnidades);
        }
    });
    
    // Validación en tiempo real
    document.getElementById('formMaterial').addEventListener('submit', function(e) {
        const stockActual = document.getElementById('id_stock_actual').value;
        const stockSeguridad = document.getElementById('id_stock_seguridad').value;
        
        if (stockActual && stockSeguridad && parseInt(stockActual) < parseInt(stockSeguridad)) {
            const confirmar = confirm('⚠️ El stock inicial es menor al stock de seguridad. ¿Deseas continuar?');
            if (!confirmar) {
                e.preventDefault();
            }
        }
    });
</script>
{% endblock %}
